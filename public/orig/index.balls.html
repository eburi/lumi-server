<!DOCTYPE html>
<html>
  <head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/lumi.js"></script>
    <script src="/javascripts/processing-1.3.6.js"></script>

    <script type="application/processing" data-processing-target="pjs">



      // All Examples Written by Casey Reas and Ben Fry

      // unless otherwise stated.

      int numBalls = 12;

      float spring = 0.08;

      float gravity = 0.02;

      Ball[] balls = new Ball[numBalls];



      void setup() 
      {

        size(32,32);

        noStroke();

        smooth();

        for (int i = 0; i < numBalls; i++) {

          balls[i] = new Ball(random(width), random(height), random(4, 8), i, balls);

        }

      }

      void draw() 

      {

        background(0);

        for (int i = 0; i < numBalls; i++) {

          balls[i].collide();

          balls[i].move();

          balls[i].display();  

        }

      }

      class Ball {

        float x, y;

        float diameter;

        float vx = 0;

        float vy = 0;

        int id;

        Ball[] others;


        Ball(float xin, float yin, float din, int idin, Ball[] oin) {

          x = xin;

          y = yin;

          diameter = din;

          id = idin;

          others = oin;

        }

        void collide() {

          for (int i = id + 1; i < numBalls; i++) {

            float dx = others[i].x - x;

            float dy = others[i].y - y;

            float distance = sqrt(dx*dx + dy*dy);

            float minDist = others[i].diameter/2 + diameter/2;

            if (distance < minDist) { 

              float angle = atan2(dy, dx);

              float targetX = x + cos(angle) * minDist;

              float targetY = y + sin(angle) * minDist;

              float ax = (targetX - others[i].x) * spring;
              float ay = (targetY - others[i].y) * spring;

              vx -= ax;

              vy -= ay;

              others[i].vx += ax;

              others[i].vy += ay;

            }

          }   

        }

        void move() {

          vy += gravity;

          x += vx;

          y += vy;

          if (x + diameter/2 > width) {

            x = width - diameter/2;

            vx += -0.9; 

          }

          else if (x - diameter/2 < 0) {

            x = diameter/2;

            vx *= -0.9;

          }

          if (y + diameter/2 > height) {

            y = height - diameter/2;

            vy *= -0.9; 

          } 

          else if (y - diameter/2 < 0) {

            y = diameter/2;

            vy *= -0.9;

          }
        }



        void display() {

          fill(255, 204);

          ellipse(x, y, diameter, diameter);

        }

      }
    </script>

    <script>
      setTimeout(function() {

        Processing.instances[0].externals.sketch.onFrameEnd = function() { 
          var canv = document.getElementById("pjs");
          var context = canv.getContext("2d");
          var imgd = context.getImageData(0,0,32,32).data;
          var pix = [];
          // Skip Alpha-Channel
          for(var i=0, l=imgd.length; i<l; i+=4) {
            pix.push(imgd[i    ]); 
            pix.push(imgd[i + 1]); 
            pix.push(imgd[i + 2]); 
          }
          lumi.sendFrame(pix);
        };
      }, 5000); 
    </script>
  </head>
  <body>
    <h1>HELLO</h1>
    <canvas id="pjs"> </canvas>
  </body>
</html>
